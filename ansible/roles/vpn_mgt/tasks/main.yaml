- name: Install deps
  ansible.builtin.apt:
    lock_timeout: 240
    update_cache: true
    pkg:
      - ca-certificates
      - bird2
      - iptables-persistent
      - wireguard

- name: Disable password auth
  ansible.builtin.lineinfile:
    dest: /etc/ssh/sshd_config
    regexp: '^#?\s*PasswordAuthentication\s'
    line: 'PasswordAuthentication no'
    state: present

- name: SSH only mgt
  ansible.builtin.lineinfile:
    dest: /etc/ssh/sshd_config
    regexp: '^#?\s*ListenAddress\s'
    line: 'ListenAddress {{ BIRD_ROUTER_ID }}'
    state: present

- name: Restart and enable sshd service
  ansible.builtin.service:
    name: sshd
    state: reloaded
    enabled: true

- name: Setup netfilter
  include_tasks: netfilter.yaml

- name: System interfaces
  include_tasks: system_interfaces.yaml

- name: Setup Interfaces + Wireguard
  include_tasks: wg_config.yaml
  loop: "{{ wireguard_configs }}"

# Down and drop unused

- name: Setup Bird
  include_tasks: bird.yaml
