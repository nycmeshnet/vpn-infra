- name: Copy bird.conf
  ansible.builtin.template:
    src: ./templates/bird.conf.j2
    dest: "/etc/bird/bird.conf"
    owner: root
    group: root
    mode: "0644"

- name: IP forward via net.ipv4.ip_forward
  ansible.posix.sysctl:
    name: net.ipv4.ip_forward
    value: '1'
    sysctl_set: true
    state: present
    reload: true

- name: Reduce Swapiness
  ansible.posix.sysctl:
    name: vm.swappiness
    value: '5'
    sysctl_set: true
    state: present
    reload: true

- name: Change Default Queuing Discipline
  ansible.posix.sysctl:
    name: net.core.default_qdisc
    value: 'fq'
    sysctl_set: true
    state: present
    reload: true

- name: Change Default TCP Congestion Control
  ansible.posix.sysctl:
    name: net.ipv4.tcp_congestion_control
    value: 'bbr'
    sysctl_set: true
    state: present
    reload: true

- name: Change TCP Keepalive Time
  ansible.posix.sysctl:
    name: net.ipv4.tcp_keepalive_time
    value: '300'
    sysctl_set: true
    state: present
    reload: true

- name: Change Default TCP Keepalive Probes
  ansible.posix.sysctl:
    name: net.ipv4.tcp_keepalive_probes
    value: '5'
    sysctl_set: true
    state: present
    reload: true

- name: Change Default TCP Keepalive Interval
  ansible.posix.sysctl:
    name: net.ipv4.tcp_keepalive_intvl
    value: '15'
    sysctl_set: true
    state: present
    reload: true

- name: Always restart bird
  ansible.builtin.lineinfile:
    path: /lib/systemd/system/bird.service
    search_string: Restart=
    line: "Restart=always"

- name: Restart and enable bird service
  ansible.builtin.systemd_service:
    name: bird
    state: reloaded
    enabled: true
    daemon_reload: true
